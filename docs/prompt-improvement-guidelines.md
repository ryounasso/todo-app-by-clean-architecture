# プロンプト改善ガイドライン

## 概要
TypeScript/NestJSからSpring Boot/Java 21への移行プロジェクトのログ分析から得られた、プロンプト改善のための重要なポイントをまとめています。

## 分析対象
- Phase 1.1〜1.5: 初期設定とプロジェクト構造
- Phase 2: ドメイン層の実装
- Phase 3: インフラストラクチャ層の実装
- Phase 4: アプリケーション層の実装
- Phase 5: Web層の実装
- Phase 8: Docker環境での統合テスト

## プロンプト改善のポイント

### 1. 段階的な実装指示の明確化

#### 問題点
- 各フェーズで何を実装すべきかが不明確
- 完了条件が曖昧
- 次のフェーズへの準備が不十分

#### 改善案
```
【各フェーズの完了条件】
Phase 1.1: Spring Bootプロジェクト生成と基本設定
Phase 1.2: クリーンアーキテクチャのディレクトリ構造作成
Phase 1.3: 設定ファイル（application.properties、Dockerfile等）の確認・更新
Phase 1.4: メインアプリケーションクラスの設定
Phase 1.5: 基本設定とテスト環境の構築
Phase 2: ドメイン層（エンティティ、DTO、リポジトリインターフェース）
Phase 3: インフラストラクチャ層（リポジトリ実装、DB設定）
Phase 4: アプリケーション層（ファクトリー、サービス）
Phase 5: Web層（コントローラー、例外処理）
Phase 6-8: 統合テスト、Docker環境、本番準備
```

### 2. 技術的な決定事項の事前提示

#### 問題点
- ID型の統一が後で問題になる
- Java 21の新機能活用が不十分
- クリーンアーキテクチャの依存関係が曖昧

#### 改善案
```
【技術要件】
- Java 21 + Spring Boot 3.5.3 + Gradle
- クリーンアーキテクチャの厳格な遵守
- PostgreSQL + Docker環境
- Java 21の新機能（Record、Stream API）を活用

【実装方針】
- ID型はlongで統一
- 各層の責務を明確に分離
- テストはH2インメモリDBを使用
- 段階的な実装（Phase 1.1〜8）
```

### 3. エラー対応の事前準備

#### 問題点
- Java 21未導入環境での対応が後手
- Docker環境での接続問題が頻発
- テスト環境の構築が不十分

#### 改善案
```
【注意事項】
- Java 21未導入環境ではJava 17で代替対応
- Docker Composeでアプリケーションも一緒に起動
- コンテナ間のネットワーク通信を確認
- テストではH2インメモリデータベースを使用して高速化
```

### 4. 検証手順の明確化

#### 問題点
- 各フェーズの完了確認が曖昧
- テスト実行のタイミングが不明確
- API動作確認の手順が不十分

#### 改善案
```
【検証手順】
各フェーズ完了後：
1. コンパイル確認: ./gradlew compileJava
2. テスト実行: ./gradlew test  
3. Docker環境確認: docker-compose up
4. API動作確認: 実際のHTTPリクエスト
5. パフォーマンス確認: レスポンス時間測定
```

### 5. アーキテクチャの一貫性維持

#### 問題点
- パッケージ構造の変更が後で発生
- 依存関係の方向が曖昧
- インターフェース設計の不整合

#### 改善案
```
【ファイル構造と命名規則】
- パッケージ構造: domain, usecases, interfaceAdapters, infrastructure
- ファイル命名: TodoController.java, TodoService.java等の一貫性
- ディレクトリ構造: interfaceAdapters/controllers/等の明確な階層
- 各層の依存関係の方向を厳格に守る
```

### 6. 具体的なファイル構造と命名規則の事前定義

#### 問題点
- パッケージ構造の変更（application→usecases）が後で発生
- ファイル命名の一貫性が不十分
- ディレクトリ構造が曖昧

#### 改善案
```
【ファイル構造と命名規則】
- パッケージ構造: domain, usecases, interfaceAdapters, infrastructure
- ファイル命名: TodoController.java, TodoService.java等の一貫性
- ディレクトリ構造: interfaceAdapters/controllers/等の明確な階層
```

### 7. テスト戦略の事前計画

#### 問題点
- テスト環境の構築が後手
- テストケースの設計が不十分
- テスト実行タイミングが不明確

#### 改善案
```
【テスト戦略】
- 各層での単体テスト実装
- H2インメモリDBによる高速テスト
- 統合テストでのDocker環境確認
- パフォーマンステスト（レスポンス時間0.024秒目標）
```

### 8. パフォーマンス要件の明確化

#### 問題点
- レスポンス時間の目標が不明確
- データベース接続設定が不十分
- インデックス設計が後手

#### 改善案
```
【パフォーマンス要件】
- レスポンス時間: 0.024秒目標
- データベース接続: HikariCP接続プールの設定
- インデックス設計: user_id, status, created_at
```

### 9. セキュリティと本番環境の事前考慮

#### 問題点
- 環境変数管理が後手
- 本番環境設定が不十分
- ヘルスチェックが実装されていない

#### 改善案
```
【セキュリティと本番環境】
- 環境変数による設定管理
- 本番環境用設定ファイル（application-prod.properties）
- ヘルスチェックエンドポイント（/health）
- ログ設定（logback-spring.xml）
```

### 10. エラーハンドリングの統一方針

#### 問題点
- 例外階層の設計が不十分
- エラーレスポンス形式が不統一
- 日本語エラーメッセージが考慮されていない

#### 改善案
```
【エラーハンドリング】
- 統一されたエラーレスポンス形式
- カスタム例外の設計（TodoNotFoundException等）
- 日本語エラーメッセージ
- グローバル例外ハンドラー
```

### 11. データベース設計の事前決定

#### 問題点
- テーブル構造が後で変更される
- マイグレーション戦略が不十分
- サンプルデータの準備が後手

#### 改善案
```
【データベース設計】
- テーブル構造: todos（id, user_id, title, status, created_at, updated_at, started_at, completed_at）
- インデックス: user_id, status, created_at
- マイグレーション: sql/01_create_todos_table.sql
- サンプルデータ: テスト用データの準備
```

### 12. 開発環境と本番環境の分離

#### 問題点
- Docker環境の分離が不十分
- 設定ファイルの管理が曖昧
- ログ設定が環境別に考慮されていない

#### 改善案
```
【開発環境と本番環境の分離】
- Docker環境: 開発・本番環境の分離
- 設定ファイル: 環境別の設定管理
- ログ設定: 環境別のログレベル
```

## 改善されたプロンプトの完全版

```
TypeScript/NestJSアプリケーションをSpring Boot/Java 21に移行してください。

【技術要件】
- Java 21 + Spring Boot 3.5.3 + Gradle
- クリーンアーキテクチャの厳格な遵守
- PostgreSQL + Docker環境
- Java 21の新機能（Record、Stream API）を活用

【実装方針】
- ID型はlongで統一
- 各層の責務を明確に分離
- テストはH2インメモリDBを使用
- 段階的な実装（Phase 1.1〜8）

【ファイル構造と命名規則】
- パッケージ構造: domain, usecases, interfaceAdapters, infrastructure
- ファイル命名: TodoController.java, TodoService.java等の一貫性
- ディレクトリ構造: interfaceAdapters/controllers/等の明確な階層

【データベース設計】
- テーブル構造: todos（id, user_id, title, status, created_at, updated_at, started_at, completed_at）
- インデックス: user_id, status, created_at
- マイグレーション: sql/01_create_todos_table.sql
- サンプルデータ: テスト用データの準備

【テスト戦略】
- 各層での単体テスト実装
- H2インメモリDBによる高速テスト
- 統合テストでのDocker環境確認
- パフォーマンステスト（レスポンス時間0.024秒目標）

【セキュリティと本番環境】
- 環境変数による設定管理
- 本番環境用設定ファイル（application-prod.properties）
- ヘルスチェックエンドポイント（/health）
- ログ設定（logback-spring.xml）

【エラーハンドリング】
- 統一されたエラーレスポンス形式
- カスタム例外の設計（TodoNotFoundException等）
- 日本語エラーメッセージ
- グローバル例外ハンドラー

【各フェーズの完了条件】
Phase 1.1: Spring Bootプロジェクト生成と基本設定
Phase 1.2: クリーンアーキテクチャのディレクトリ構造作成
Phase 1.3: 設定ファイル（application.properties、Dockerfile等）の確認・更新
Phase 1.4: メインアプリケーションクラスの設定
Phase 1.5: 基本設定とテスト環境の構築
Phase 2: ドメイン層（エンティティ、DTO、リポジトリインターフェース）
Phase 3: インフラストラクチャ層（リポジトリ実装、DB設定）
Phase 4: アプリケーション層（ファクトリー、サービス）
Phase 5: Web層（コントローラー、例外処理）
Phase 6-8: 統合テスト、Docker環境、本番準備

【検証手順】
各フェーズ完了後：
1. コンパイル確認: ./gradlew compileJava
2. テスト実行: ./gradlew test  
3. Docker環境確認: docker-compose up
4. API動作確認: 実際のHTTPリクエスト
5. パフォーマンス確認: レスポンス時間測定

【注意事項】
- Java 21未導入環境ではJava 17で代替対応
- パッケージ構造の変更（application→usecases）を考慮
- 各層の依存関係の方向を厳格に守る
- 本番環境ではDB_PASSWORD環境変数を適切に設定
```

## 結論

移行ログの分析から、プロンプト改善のための12の重要なポイントを特定しました。これらのポイントを事前にプロンプトに含めることで、より実用的で成功確率の高い移行プロジェクトを実現できます。

特に重要なのは：
1. **段階的な実装指示の明確化**
2. **技術的な決定事項の事前提示**
3. **エラー対応の事前準備**
4. **検証手順の明確化**
5. **アーキテクチャの一貫性維持**

これらの要素を組み込むことで、AIによる移行プロジェクトの成功率と品質を大幅に向上させることができます。 